name: Continuous Integration

on: [push, pull_request, fork]

jobs:

  build:

    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8.15'
      - uses: actions/setup-java@v1
        with:
          java-version: 11
      - run: echo "JAVA11_HOME=$JAVA_HOME" >> $GITHUB_ENV
      - uses: actions/setup-java@v1
        with:
          java-version: 8
      - name: install untangling-benchmark-tools
        run: |
          git clone https://github.com/Thomsch/untangling-tools-benchmark
          cd untangling-tools-benchmark
      - name: install Flexeme
        run: |
          git clone https://github.com/Thomsch/Flexeme ~/Flexeme
          brew install graphviz
          pip install pygraphviz
          pip install -e ~/Flexeme
      - name: install Python modules and MacOS dependencies
        run: |
          pip install -U -r requirements.txt
          brew install cpanminus
          brew install wget
          brew install coreutils
      - name: install defects4j
        run: |
          git clone https://github.com/rjust/defects4j ~/defects4j
          cd defects4j
          cpanm --installdeps .
          ./init.sh
      - name: set up environment variables
        run: |
          current_path=$(pwd)
          D4J_EXEC="$current_path/framework/bin"
          export PATH="$D4J_EXEC:$PATH"
          echo "DEFECTS4J_HOME=$current_path" >> $GITHUB_ENV
          echo "JAVA_11=$JAVA11_HOME/bin/java" >> $GITHUB_ENV
      - name: check installations and dependencies
        run: ./test/check_installation.sh
      - name: run end-to-end tests
        run: |
          export PYTHONHASHSEED=0
          ./test/e2e.sh