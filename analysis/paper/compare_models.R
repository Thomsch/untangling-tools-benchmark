#!/usr/bin/env Rscript
#
# Generates the table comparing the impact of random effects on the linear model.
# Input: The CSV file containing the decomposition scores generated by `decompose.sh`.
# Output: The path where save the output table as a .tex file.
library(tidyverse)
library(effsize)
library(lmerTest)
library(flexplot)
library(ggplot2)
library(rsq)
library(xtable)

args = commandArgs(trailingOnly=TRUE)

if (length(args)!=2) {
  stop("Please provide an input file and output file.", call.=FALSE)
}

inputFile = args[1]
outputFile = args[2]

#
# We use R to handle the linear mixed models because Python doesn't support lmms with 2 random effects (cross effects).
#
data <- read.csv(inputFile, header = FALSE, col.names = c('Project', 'BugID', 'SmartCommit', 'Flexeme', 'FileUntangling'))
data <- subset(data, select = -c(FileUntangling))
data$BugID <- as_factor(data$BugID)

# Convert to long format
data_long = pivot_longer(data, cols = 3:4, names_to = 'Tool', values_to = 'Performance')

# Random model
model_mixed <- lmer(Performance ~ Tool + (1|Project) + (1|BugID), data=data_long)

# Simplified m
model_simple <- lm(Performance ~ Tool, data=data_long)

# Printing on the console
print("Model with Random Effects")
summary(model_mixed) # Coefficients and P-Value
rsq(model_mixed, adj=TRUE) # Adjusted R^2

print("Model without Random Effects")
summary(model_simple) # Coefficients and P-Value
rsq(model_simple, adj=TRUE) # Adjusted R^2

# Print results in tidy format.

# Create Coefficients dataframe
coeffs = rbind(summary(model_mixed)$coefficients[, "Estimate"], summary(model_simple)$coefficients[, "Estimate"])
colnames(coeffs) <- c('Flexeme', 'SmartCommit')
# Create p-values dataframe
p_vals = rbind(summary(model_mixed)$coefficients[, "Pr(>|t|)"], summary(model_simple)$coefficients[, "Pr(>|t|)"])
colnames(p_vals) <- c('Flexeme', 'SmartCommit')

tool_stats <- cbind(coeffs, p_vals)
tool_stats <- rbind(colnames(tool_stats),tool_stats)
colnames(tool_stats) = NULL
rownames(tool_stats) <- c("","With Random Effects", "Without Random Effects")
tool_stats <- xtable(tool_stats)
addtorow <- list()
addtorow$pos <- list(0)
addtorow$command <- paste0(paste0('& \\multicolumn{2}{c}{', c("Coefficient","P-value"), '}', collapse=''), "", '\\\\')

# Multicolumn table with 2 tools as independent variables
print(tool_stats, add.to.row=addtorow, include.colnames=F, timestamp	= NULL, comment = FALSE, include.rownames = TRUE, file=outputFile)

# Adjusted R-squared for the 2 models
summary <- data.frame(
  Model = c("With Random Effects", "Without Random Effects"),
  Adjusted_R = t(cbind(rsq(model_mixed, adj=TRUE)[1], rsq(model_simple, adj=TRUE)[1]))
)
colnames(summary) <- c("Model", "Adjusted R^2")
print(summary)
