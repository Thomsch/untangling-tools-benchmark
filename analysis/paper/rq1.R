#!/usr/bin/env Rscript
#
# Generates statistical analysis for RQ1 with p-value, Cohen's d, R^2, and model residuals normality test results.
# Input: The `decomposition_scores.csv` file generated by `decompose.sh`.
# Output: The path to the file where the results will be saved.

library(tidyverse)
library(car)
library(ggpubr)
library(lme4)
library(effsize)
library(lmerTest)
library(flexplot)
library(rsq)

args = commandArgs(trailingOnly=TRUE)

if (length(args)!=2) {
  stop("Please provide an input file and output file.", call.=FALSE)
}
inputFile = args[1]
outputFile = args[2]

data <- read.csv(inputFile, header = FALSE, col.names = c('Project', 'BugID', 'SmartCommit', 'Flexeme', 'FileUntangling'))
data <- subset(data, select = -c(FileUntangling))
data$BugID <- as_factor(data$BugID)

# Convert to long format
data_long = pivot_longer(data, cols = 3:4, names_to = 'Tool', values_to = 'Performance')

# The summary can be interpreted as follows:
# Intercept row shows whether the baseline treatment (whichever is first) is significantly different from 0.
# The second row, containing the other treatment shows whether the other treatment is significantly different from
# the intercept.

model <- lm(Performance ~ Tool, data=data_long)
# Residuals
# It is recommended to look at the residuals to check for normality rather than apply a statistical test.
visualize(model, "residuals")

sink(outputFile)
summary(model)
#estimates(model_simple)

cohen.d(data_long$Performance[data_long$Tool == "SmartCommit"], data_long$Performance[data_long$Tool == "Flexeme"])
sink()
