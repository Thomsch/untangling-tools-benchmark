#!/usr/bin/env Rscript
#
# Generates statistical analysis for the commit metrics with p-value, Cohen's d, R^2.
#
# Arguments:
# - 1. The `decomposition_scores.csv` file generated by `decompose.sh`.
# - 2. The `metrics.csv` file generated by `get_metrics.sh`.
# - 3. The path to file where results will be saved.
#
# Output:
# 1. Generate `impact_metrics_all.txt`. This file contains the statistical model for all the metrics against the performance.
# 2. Generate `impact_metrics_smartcommit_all.txt`. This file contains the statistical model for all the metrics against the performance of SmartCommit exclusively.
# 3. Generate `impact_metrics_flexeme_all.txt`. This file contains the statistical model for all the metrics against the performance of Flexeme exclusively.
# 4. Generate `smartcommit/` and `flexeme/` folders. Each folder contains
# - `impact_<metric>_<tool>.txt`. Contains the statistical model for each `<metric>` available against the performance. `<tool>` corresponds to the name of the folder the file is in.
# - `impact_separate_<tool>.pdf`. Contains a plot of the model for each metric against the performance separately.


library(tidyverse)
library(flexplot)
library(effsize) # For cohen.d

args = commandArgs(trailingOnly=TRUE)

if (length(args)!=3) {
  stop("Please provide the path to decomposition_scores.csv, metrics.csv, and where to save the results.", call.=FALSE)
}

performance.path = args[1]
metrics.path = args[2]
outputPath = args[3]

# Function to convert character columns to numeric
convert_to_numeric <- function(dataframe, numeric_variables) {
  for (col in numeric_variables) {
    if (is.character(dataframe[[col]])) {
      dataframe[[col]] <- as.numeric(dataframe[[col]])
    }
  }
  return(dataframe)
}

# Summarizes a linear model for the given data on the performance vs commit metrics.
# Prints the results to a new file in a path.
summarise_model_all_variables <- function(data, output.path, output.filename) {
  # Simple model because we proved in RQ1 that bug_id and project are not significant.
  
  if("Tool" %in% colnames(data))
  {
    model <- lm(performance ~ Tool + files_updated + hunks + average_hunk_size + code_changed_lines + tangled_lines + tangled_hunks, data=data)
  } else {
    model <- lm(performance ~ files_updated + hunks + average_hunk_size + code_changed_lines + tangled_lines + tangled_hunks, data=data)
  }
  
  capture.output(summary(model), file=file.path(output.path, output.filename))
}

# Summarizes a linear model for performance against each metrics separately.
# Print the model summary to a file and generates a plot of the model.
# Arguments
# data: the dataframe containing the data
# metrics.names: a list of metrics to generate the summary and plot for
# output.tool: name of the tool the data belongs to
# output.path: where to generate the summary and plot
generate_pairwise_analysis <- function(data, metrics.names, output.tool, output.path) {
  output.tool.path <- file.path(output.path, output.tool)
  dir.create(output.tool.path, showWarnings = FALSE)
  
  rplot.path <- file.path(getwd(), "Rplots.pdf")
  output.file.name <- paste("impact", "separate", output.tool, sep = '_')
  output.file.pdf <- paste(output.file.name, '.pdf', sep = '')
  
  pdf(file.path(output.tool.path, output.file.pdf))

  for (metric.name in metrics.names) {
    lm_formula <- as.formula(paste("performance", "~", metric.name))
    model <- lm(lm_formula, data=data)
    
    output.file.name <- paste("impact", metric.name, output.tool, sep = '_')
    output.file.txt <- paste(output.file.name, '.txt', sep = '')
    capture.output(summary(model), file=file.path(output.tool.path, output.file.txt))
    capture.output(cohen.d(data$performance, data[[metric.name]]), file=file.path(output.tool.path, output.file.txt), append = TRUE)
    
    print(visualize(model, "model", alpha = 0.1, jitter = c(0.3, .1)))
  }
  
  dev.off()
}

# Decomposition scores
performance.data <- read.csv(performance.path, header = FALSE, col.names = c('project', 'bug_id', 'smartcommit_rand_index', 'flexeme_rand_index', 'file_untangling'))

# Commit metrics
metrics.data <- read.csv(metrics.path)
metrics.names <- colnames(metrics.data %>% select(-c('project', 'vid')))

# Join performance with metrics
performance.metrics <- left_join(performance.data, metrics.data, by = c('project' = 'project', 'bug_id' = 'vid'))

# Global
performance.metrics.long = pivot_longer(performance.metrics, cols = c('smartcommit_rand_index', 'flexeme_rand_index', 'file_untangling'), names_to = 'Tool', values_to = 'performance')
summarise_model_all_variables(performance.metrics.long, outputPath, "impact_metrics_all.txt")

# SmartCommit All
performance.metrics.smartcommit <- select(performance.metrics, -c('flexeme_rand_index', 'file_untangling'))  %>% rename(performance = smartcommit_rand_index)
summarise_model_all_variables(performance.metrics.smartcommit, outputPath, "impact_metrics_smartcommit_all.txt")

# Flexeme All
performance.metrics.flexeme <- select(performance.metrics, -c('smartcommit_rand_index', 'file_untangling'))  %>% rename(performance = flexeme_rand_index)
summarise_model_all_variables(performance.metrics.flexeme, outputPath, "impact_metrics_flexeme_all.txt")

# File Untangling ALL
performance.metrics.file <- select(performance.metrics, -c('smartcommit_rand_index', 'flexeme_rand_index'))  %>% rename(performance = file_untangling)
summarise_model_all_variables(performance.metrics.file, outputPath, "impact_metrics_file_all.txt")

# For each metric, do model analysis and print graph in pdf
generate_pairwise_analysis(performance.metrics.smartcommit, metrics.names, "smartcommit", outputPath)
generate_pairwise_analysis(performance.metrics.flexeme, metrics.names, "flexeme", outputPath)
generate_pairwise_analysis(performance.metrics.file, metrics.names, "file", outputPath)
