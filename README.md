# Untangling Tools Benchmark
Scripts to run the code changes benchmark.

## Requirements
- [Defects4J](https://github.com/rjust/defects4j) is installed and `defects4j` is on the PATH.
- Java 8 is installed and `java` is on the PATH.
- `python3` is installed and on the PATH.

### Environment Variables
- `DEFECTS4J_HOME`: Location of the defect4j installation.
- `JAVA_SMARTCOMMIT`: Location of the java executable to run SmartCommit. Requires Java 11

## Untangling one D4J bug
1. Clone `https://github.com/Thomsch/Flexeme` locally.
2. Install Flexeme from the clone `pip install -e path/to/flexeme/clone`.
3. Install local dependencies `pip install -r requirements.txt`.
4. Run `./evaluate.sh <project> <bug_id> <out_dir> <repo_dir>. This will run the decomposition on the specified Defects4J <bug_id> in <project>. <out_dir> will contain the results of the decomposition. <repo_dir> is the directory used by Defects4J to checkout the specified project.

## Running the benchmark
1. Follow installation instructions in `Untangling one D4J bug` section.
2. Run `scripts/active_bugs.sh > out/all-commits.csv` (will generate from all project. Project `Chart` is not compatible
   with SmartCommit because it uses SVN)
    - Remove commits from `Chart` project from `out/commit.csv` because they are incompatible with SmartCommit. See **
      Limitations** sections.
3. Run `scripts/sample_bugs.sh out/all-commits.csv <n> > sampled_bugs.csv` with `<n>` indicating the number of bugs to sample.
4. Run `./evaluate_all.sh sampled_bugs.csv`.

### Aggregating decomposition elapsed time
All decomposition are timed. The result is stored in each decomposition folder.
To aggregated all of the results in one file, run `scripts/aggregate_time.sh`. 
It will create `out/time.csv` containing the runtime of each decomposition.

## Adding an untangling tool
Add a call to your untangling tool executable in `evaluate.sh`. Use the existing tools' code as a template.

## Limitations
- SmartCommit doesn't support SVN projects. For now, all commits in a SVN project are ignored by manually removing lines containing `Chart` in `out/commits.csv`.

## How the benchmark works (WIP)
- `out/commit.csv` contains the commits in Defects4J. Generated by `./scripts/active_bugs.sh`.
- Tools are running in parallel.
- Decomposition results outputs independently.
- Commits are checked out once since disk operations are a bottleneck
- All results are located in `<out_dir>` (e.g., `./out`)
    - `./out/decomposition/` contains the decomposition from different tools. Data directory.
    - `./out/evaluation/` contains the aggregated changed lines and ground truth
        - Organized per project / and bug id (vid). E.g., `./out/evaluation/<project>/<vid>`:
            - `./out/evaluation/<project>/<vid>/truth.csv`
            - `./out/evaluation/<project>/<vid>/approach1.csv`
            - `./out/evaluation/<project>/<vid>/approach2.csv`
    - `./out/results/` contains the aggregated results for the paper.

- Decomposition runs on a list of bugs.
    - Each bug runs all the approaches in parallel
    - Ground truth is run also calculated in parallel

## Improvements ideas
- Use Make to run the build pipeline.
    - The main benefit is that Make will take care of regenerating the correct files based on what is available / changed.
      - make: Use filename wildcard for each bug
      - rake has this options
